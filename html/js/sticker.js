function BXSticker(t,e,i){this.MESS=i,this.Stickers=e||[],this.Params=t,this.sessid_get=t.sessid_get,this.bShowStickers=t.bShowStickers,this.curEditorStickerInd=!1,this.oneGifSrc="/bitrix/images/1.gif",this.colorSchemes=[{name:"bxst-yellow",color:"#FFFCB3",title:this.MESS.Yellow},{name:"bxst-green",color:"#DBFCCD",title:this.MESS.Green},{name:"bxst-blue",color:"#DCE7F7",title:this.MESS.Blue},{name:"bxst-red",color:"#FCDFDF",title:this.MESS.Red},{name:"bxst-purple",color:"#F6DAF8",title:this.MESS.Purple},{name:"bxst-gray",color:"#F5F5F5",title:this.MESS.Gray}],this.curPageCount=this.Params.curPageCount,this.Params.useHotkeys&&BX.bind(document,"keyup",BX.proxy(this.OnKeyUp,this)),window.__bxst_result={},t.bShowStickers&&this.Init(t)}function BXStickerList(t){this.BXSticker=t,this.access=this.BXSticker.access,this.MESS=this.BXSticker.MESS,this.arCurPageIds={}}BXSticker.prototype={Init:function(t){this.oMarkerConfig={attr:{title:!0,src:!0,href:!0,alt:!0,"class":!0,className:!0,id:!0,name:!0,type:!0,value:!0},impAttr:{src:!0,id:!0,name:!0,href:!0}},this.Params.changeColorEffect=!0,this.arStickers=[],this.posReg={},this.bInited=!0,this.access=this.Params.access,this._arSavedStickers={},BX.bind(document,"mousedown",BX.proxy(this.OnMousedown,this));var e=this;BX.addCustomEvent("onMenuOpen",function(){var t=BX.findChild(BX("bxst-show-sticker-icon"),{className:"icon"},!0);t&&(e.bShowStickers?BX.addClass(t,"checked"):BX.removeClass(t,"checked")),e.UpdateStickersCount()}),this.DisplayStickers(!!t.bVisEffects),this.ShowEditor({ind:-1})},ShowAll:function(t,e){"undefined"==typeof t&&(t=!this.bShowStickers);var i=this,s=BX.findChild(BX("bxst-show-sticker-icon"),{className:"icon"},!0);if(s&&(t?BX.addClass(s,"checked"):BX.removeClass(s,"checked")),this.bShowStickers=t,window.__bxst_result.show=null,window.__bxst_result.stickers=null,this.Request(t?"show_stickers":"hide_stickers",{pageUrl:this.Params.pageUrl,b_inited:this.bInited?"Y":"N"},function(t){i.bInited||(i.bShowStickers=window.__bxst_result.show,window.__bxst_result.stickers&&(i.Stickers=window.__bxst_result.stickers,i.Params.bVisEffects=!0,i.bInited||i.Init(i.Params),e&&i.AddSticker()))}),t){if(t&&this.bInited)for(var r,o=0,a=this.arStickers.length;o<a;o++)r=this.arStickers[o],r.pWin.Get().style.display="block",r.pShadow.style.display="block",r.pMarker&&(r.pMarker.style.display="")}else this.HideAll()},HideAll:function(){for(var t,e=0,i=this.arStickers.length;e<i;e++)t=this.arStickers[e],t.pWin.Get().style.display="none",t.pShadow.style.display="none",t.pMarker&&(t.pMarker.style.display="none")},AddSticker:function(t,e,i){if(!this.bInited)return this.ShowAll(!0,!0);if(!this.bShowStickers&&this.bInited&&this.ShowAll(!0,!1),this.curEditorStickerInd!==!1){var s=this;return this.SaveAndCloseEditor(this.curEditorStickerInd,!0,!0),setTimeout(function(){s.AddSticker(t,e,i)},300)}var r;r=t?this.ConvertStickerObj(t):{bNew:!0,personal:!1,colorInd:parseInt(this.Params.start_color),width:parseInt(this.Params.start_width),height:parseInt(this.Params.start_height),collapsed:!1,completed:!1,info:"&nbsp;"};var o=this.CreateWindow(r,!!e,i);r.bNew&&this.SetMarker(o,"area")},CreateWindow:function(t,e,i){var s=new BX.CWindow((!1),"float");s.Show(!0),s.Get().style.zIndex=s.zIndex=this.Params.zIndex,s.SETTINGS.min_width=this.Params.min_width,s.SETTINGS.min_height=this.Params.min_height,BX.addClass(s.Get(),"bx-sticker"),s.DenyClose();var r,o="R"==this.access,a=!!t.bNew,n=this,l=this.arStickers.length,d=s.Get().appendChild(BX.create("DIV",{props:{className:"bxst-header",id:"bxst_head_"+l}})),c=d.appendChild(BX.create("DIV",{props:{className:"bxst-id-cont bxst-title"},html:t.id>0?'<a href="'+this.Params.pageUrl+"?show_sticker="+t.id+'"><span>'+t.id+"</span></a>":""})),h=d.appendChild(BX.create("DIV",{props:{className:"bxst-check-cont"}})),p=h.appendChild(BX.create("INPUT",{props:{id:"bxst_conplited_"+l,name:"bxst_conplited_"+l,type:"checkbox",value:"Y",title:this.MESS.Complete}})),u=(h.appendChild(BX.create("LABEL",{attrs:{"for":"bxst_conplited_"+l,title:this.MESS.Complete},text:this.MESS.CompleteLabel})),d.appendChild(BX.create("DIV",{props:{id:"bxst_col_title_"+l,className:"bxst-col-title-cont",title:this.MESS.UnCollapseTitle}}))),k=d.appendChild(BX.create("DIV",{props:{className:"bxst-close bxst-but",title:this.MESS.Close}})).appendChild(BX.create("IMG",{props:{id:"bxst_close_"+l,src:this.oneGifSrc,className:"bxst-sprite"}})),S=d.appendChild(BX.create("DIV",{props:{className:"bxst-collapse bxst-but"}})).appendChild(BX.create("IMG",{props:{id:"bxst_collapse_"+l,src:this.oneGifSrc,className:"bxst-sprite",title:this.MESS.Collapse}}));(a||this.Params.curUserId==t.authorId)&&(r=d.appendChild(BX.create("DIV",{props:{id:"bxst_type_"+l,className:"bxst-type-cont"}})),r.appendChild(BX.create("DIV",{props:{className:"bxst-type-l bxst-type-corn"}})),r.appendChild(BX.create("DIV",{props:{className:"bxst-type-c bxst-type-c-publ"}})).appendChild(BX.create("SPAN",{props:{},text:this.MESS.Public})),r.appendChild(BX.create("DIV",{props:{className:"bxst-type-c  bxst-type-c-pers"}})).appendChild(BX.create("SPAN",{props:{},text:this.MESS.Personal})),r.appendChild(BX.create("DIV",{props:{className:"bxst-type-r bxst-type-corn"}})),o||(r.onclick=function(){s.__stWasDragged||n.SetType(parseInt(this.id.substr("bxst_type_".length)),!0)}),this.SetUnselectable([r]));var b=s.Get().appendChild(BX.create("DIV",{props:{id:"bxst_body_"+l,className:"bxst-content"}})),f=b.appendChild(BX.create("DIV",{props:{id:"bxst_content_"+l,className:"bxst-content-area"}})),m=s.Get().appendChild(BX.create("DIV",{props:{className:"bxst-footer"}})),C=m.appendChild(BX.create("DIV",{props:{className:"bxst-marker-area-but"}})).appendChild(BX.create("IMG",{props:{id:"bxst_marker_but0_"+l,src:this.oneGifSrc,className:"bxst-sprite",title:this.MESS.SetMarkerArea}})),y=m.appendChild(BX.create("DIV",{props:{className:"bxst-marker-elem-but"}})).appendChild(BX.create("IMG",{props:{id:"bxst_marker_but1_"+l,src:this.oneGifSrc,className:"bxst-sprite",title:this.MESS.SetMarkerEl}})),w=m.appendChild(BX.create("DIV",{props:{className:"bxst-ctrl-txt bxst-color-but"}})).appendChild(BX.create("SPAN",{props:{id:"bxst_color_"+l},text:this.MESS.Color})),v=m.appendChild(BX.create("DIV",{props:{className:"bxst-ctrl-txt bxst-add-but"}})).appendChild(BX.create("SPAN",{props:{id:"bxst_add_but_"+l},text:this.MESS.Add})),M=m.appendChild(BX.create("DIV",{props:{className:"bxst-resizer"}})).appendChild(BX.create("IMG",{props:{src:this.oneGifSrc,className:"bxst-sprite"}})),_=m.appendChild(BX.create("DIV",{props:{className:"bxst-info-icon"}})).appendChild(BX.create("IMG",{props:{id:"bxst_info_"+l,src:this.oneGifSrc,className:"bxst-sprite"},style:{display:a?"none":"block"}})),g=new BX.CHintSimple({parent:_,hint:t.info});o&&BX.addClass(s.Get(),"bx-sticker-readonly");var B=BX.GetWindowInnerSize(),x=BX.GetWindowScrollPos();if((a||t.left<=0||t.top<=0)&&(t.left=s.Get().style.left=parseInt(x.scrollLeft+B.innerWidth/2-parseInt(s.Get().offsetWidth)/2)+Math.round(t.width/2),t.top=Math.max(parseInt(x.scrollTop+B.innerHeight/2-parseInt(s.Get().offsetHeight)/2),0)-Math.round(t.height/2)),s.StickerInd=l,a&&(v.style.display="none"),pShadow=document.body.appendChild(BX.create("DIV",{props:{className:"bxst-shadow"},style:{zIndex:parseInt(s.Get().style.zIndex)-5}})),this.RegisterSticker({obj:t,pWin:s,pCheck:p,pCloseBut:k,pCollapseBut:S,pCollapsedTitle:u,pBody:b,pHead:d,pTypeCont:r||!1,pContentArea:f,pIdsCont:c,pShadow:pShadow,bButPanelShowed:!0,pMarkerAreaBut:C,pMarkerElementBut:y,pColorBut:w,pAddBut:v,pInfo:_,pHint:g,_over:!a&&!i,bButPanelShowed:!a&&!i}),this.AdjustToSize(l,t.width,t.height),this.SetColorScheme(l,t.colorInd,!1),this.SetType(l,!1,t.personal?"personal":"public"),this.SetCompleted(l,t.completed,!1),this.CollapseSticker(l,!1,t.collapsed),s.SetDraggable(d),BX.addCustomEvent(s,"onWindowDragStart",function(){this.__stWasDragged=!0}),BX.addCustomEvent(s,"onWindowDragFinished",function(){n.OnDragEnd(this)}),BX.addCustomEvent(s,"onWindowDrag",function(){n.OnDragDrop(this)}),s.SetResize(M),BX.addCustomEvent(s,"onWindowResize",function(){n.AdjustToSize(this.StickerInd)}),BX.addCustomEvent(s,"onWindowResizeStart",function(){n.OnResizeStart(this)}),BX.addCustomEvent(s,"onWindowResizeFinished",function(){n.OnResizeEnd(this)}),d.ondblclick=function(){n.CollapseSticker(parseInt(this.id.substr("bxst_head_".length)),!0)},S.onclick=function(){s.__stWasDragged||n.CollapseSticker(parseInt(this.id.substr("bxst_collapse_".length)),!0)},o?p.disabled=!0:(k.onclick=function(){s.__stWasDragged||n.CloseSticker(parseInt(this.id.substr("bxst_close_".length)),!0)},v.onclick=function(){n.AddToSticker(parseInt(this.id.substr("bxst_add_but_".length)))},p.onclick=function(){s.__stWasDragged||n.SetCompleted(parseInt(this.id.substr("bxst_conplited_".length)),!!this.checked,!0)},w.onclick=function(){n.ShowColorSelector(parseInt(this.id.substr("bxst_color_".length)))},C.onclick=function(){n.SetMarker(parseInt(this.id.substr("bxst_marker_but0_".length)),"area")},y.onclick=function(){n.SetMarker(parseInt(this.id.substr("bxst_marker_but1_".length)),"element")}),a||i||t.collapsed||(s.Get().style.height=t.height-24+"px"),a){var I=this.GetSuitablePosition(t.left,t.top);I!==!0&&(t.left=I.left,t.top=I.top)}else c.style.display="block";return this.RegisterPosition(t.left,t.top),s.Get().style.left=t.left+"px",s.Get().style.top=t.top+"px",this.SupaFlySticker(l),this.AdjustShadow(l),this.SetUnselectable([k,S,w,C,C,M]),a||i===!0?(this.ShowEditor({ind:l}),i&&(this.OnDivMouseOver(l,!0),this.DisplayMarker(l))):(b.style.overflow="auto",f.innerHTML=t.html_content,this.DisplayMarker(l),t.id==this.Params.focusOnSticker&&(window.scrollTo(0,t.top>200?t.top-200:0),this.Hightlight(l,!0),this.BlinkRed(l))),o||(b.onclick=function(){if(this.id){var t=parseInt(this.id.substr("bxst_body_".length));n.curEditorStickerInd!==t&&n.ShowEditor({ind:t})}}),s.Get().onmouseover=function(){n.OnDivMouseOver(l,!0)},s.Get().onmouseout=function(){n.OnDivMouseOver(l,!1)},l},UpdateNewSticker:function(t){var e=this.arStickers[t];e.pAddBut.style.display="block",e.pInfo.style.display="block",e.pIdsCont.style.display="block",e.pIdsCont.innerHTML='<a href="'+this.Params.pageUrl+"?show_sticker="+e.obj.id+'"><span>'+e.obj.id+"</span></a>",t===this.curEditorStickerInd&&"object"==typeof window.oLHESticker&&(setTimeout(function(){oLHESticker.SetFocusToEnd()},100),setTimeout(function(){oLHESticker.SetFocusToEnd()},500))},RegisterPosition:function(t,e){var i=20,s=Math.round(t/i)*i,r=Math.round(e/i)*i;this.posReg[s+"_"+r]=!0},GetSuitablePosition:function(t,e,i){var s=20,r=Math.round(t/s)*s,o=Math.round(e/s)*s;return this.posReg[r+"_"+o]?this.GetSuitablePosition(t+s,e+s,!0):!i||{left:t,top:e}},RegisterSticker:function(t){return this.arStickers.push(t),this.arStickers.length-1},AdjustToSize:function(t,e,i){var s,r=this.arStickers[t];"undefined"==typeof e||"undefined"==typeof i?(e=parseInt(r.pWin.Get().style.width),i=parseInt(r.pWin.Get().style.height)):(r.pWin.Get().style.width=e+"px",r.pWin.Get().style.height=i+"px"),s=BX.browser.IsIE()&&!BX.browser.IsDoctype()?i-19-27-0:i-19-24-0,window.oLHESticker&&(window.oLHESticker.pFrame.style.width=e-2+"px",window.oLHESticker.pFrame.style.height=s-2+"px",window.oLHESticker.ResizeFrame(s-2)),r.pCollapsedTitle.style.width=e-100+"px",r.pBody.style.height=s+"px",this.AdjustShadow(t)},AdjustShadow:function(t){var e=this.arStickers[t];return e.obj.closed&&e.pShadow.parentNode?e.pShadow.parentNode.removeChild(e.pShadow):(e.pShadow.style.top=parseInt(e.pWin.Get().style.top)+4+"px",e.pShadow.style.left=parseInt(e.pWin.Get().style.left)+3+"px",e.pShadow.style.width=e.pWin.Get().style.width,void(e.pShadow.style.height=e.pWin.Get().style.height))},AdjustEditorSizeAndPos:function(t){var e=this.arStickers[t];this.pEditorCont.style.top=parseInt(e.pWin.Get().style.top)+20+"px",this.pEditorCont.style.left=e.pWin.Get().style.left,this.pEditorCont.style.width=e.pWin.Get().style.width,this.pEditorCont.style.height=e.pBody.style.height,this.pEditorCont.style.zIndex=parseInt(e.pWin.Get().style.zIndex)+10},AdjustHintToCursor:function(t,e){t.style.left=e.realX+30+"px",t.style.top=e.realY-12+"px"},AdjustScrollPosToCursor:function(){},AdjustStickerToArea:function(t){var e,i,s=BX.GetWindowInnerSize(document),r=BX.GetWindowScrollPos(document),o=this.arStickers[t],a=o.obj.marker&&o.obj.marker.adjust?0:10;o.pMarker&&o.obj.marker&&(e=o.obj.marker.left+o.obj.marker.width-60,i=o.obj.marker.top-o.obj.height+a,e+o.obj.width>s.innerWidth&&(e=s.innerWidth-o.obj.width-30),i<r.scrollTop+50&&(i=o.obj.marker.top+o.obj.marker.height-a)),this.MoveToPos(t,{left:e,top:i}),o.obj.top=i,o.obj.left=e,this.arStickers[t].obj.id&&this.SaveSticker(t)},MoveToPos:function(t,e){var i=this.arStickers[t],s=parseInt(i.obj.top),r=parseInt(i.obj.left),o=parseInt(e.top),a=parseInt(e.left),n=parseInt(s),l=parseInt(r),d=this,c=0,h=s>o,p=r>a,u=(BX.browser.IsIE(),10),k=(BX.browser.IsIE(),10,Math.ceil(Math.abs((r-a)/50))),S=Math.ceil(Math.abs((s-o)/50)),b=p?-k:k,f=h?-S:S,m=function(e,s){e!==!1&&(i.pWin.Get().style.top=e+"px"),s!==!1&&(i.pWin.Get().style.left=s+"px"),d.AdjustShadow(t)},C=setInterval(function(){return o!=n&&n!==!1&&(n+=Math.round(f*c/2)),a!=l&&l!==!1&&(l+=Math.round(b*c/2)),n!==!1&&(!h&&n>=o||h&&n<=o)&&(n=o),l!==!1&&(!p&&l>=a||p&&l<=a)&&(l=a),m(n,l),n==o&&(n=!1),l==a&&(l=!1),n===!1&&l===!1?(clearInterval(C),d.OnDragEnd(i.pWin)):void c++},u)},ChangeColor:function(t,e,i,s){this.arStickers[t];return this.Params.changeColorEffect||(i=!1),i&&s===!0?(this.Params.start_color=e,this.ShowColorOverlay(t,e,!0)):(i&&s===!1||!i)&&(this.SetColorScheme(t,e,!0),i)?this.ShowColorOverlay(t,e,!1):void 0},SetColorScheme:function(t,e,i){t===this.curEditorStickerInd&&"object"==typeof window.oLHESticker&&window.oLHESticker.pEditorDocument&&window.oLHESticker.pEditorDocument.body&&(window.oLHESticker.pEditorDocument.body.className=this.colorSchemes[e].name),this.arStickers[t].obj.colorInd=e;for(var s=0,r=this.colorSchemes.length;s<r;s++)s==e?BX.addClass(this.arStickers[t].pWin.Get(),this.colorSchemes[s].name):BX.removeClass(this.arStickers[t].pWin.Get(),this.colorSchemes[s].name);if(this.arStickers[t].pMarker&&(this.arStickers[t].pMarker.className="bxst-sticker-marker "+this.colorSchemes[e].name),i&&this.arStickers[t].obj.id>0){var o=this;this.arStickers[t]._colTimeout&&(clearTimeout(this.arStickers[t]._colTimeout),this.arStickers[t]._colTimeout=null),o.SaveSticker(t)}},SetType:function(t,e,i){var s=this.arStickers[t],r="undefined"==typeof i?!s.obj.personal:"personal"==i;s.pTypeCont&&(r?(BX.addClass(s.pTypeCont,"bxst-type-pers"),BX.removeClass(s.pTypeCont,"bxst-type-publ"),s.pTypeCont.title=this.MESS.PersonalTitle):(BX.addClass(s.pTypeCont,"bxst-type-publ"),BX.removeClass(s.pTypeCont,"bxst-type-pers"),s.pTypeCont.title=this.MESS.PublicTitle),s.obj.personal=r,s.obj.id&&e&&this.SaveSticker(t))},SetCompleted:function(t,e,i){this.arStickers[t].obj.completed=e,this.arStickers[t].pCheck.checked=e,this.arStickers[t].obj.id&&i&&this.SaveSticker(t)},CloseSticker:function(t,e,i){var s=this.arStickers[t];if(!e||!s.obj.authorName||this.Params.curUserId==s.obj.authorId||confirm(this.MESS.CloseConfirm.replace("#USER_NAME#",s.obj.authorName))){s.obj.closed=!s.obj.closed,t===this.curEditorStickerInd&&(this.curEditorStickerInd=!1),this.arStickers[t].pWin.Close(!0),this.arStickers[t].pWin.onUnRegister(!0),s.pMarkerNode&&BX.removeClass(s.pMarkerNode,"bxst-sicked"),s.pMarker&&s.pMarker.parentNode&&s.pMarker.parentNode.removeChild(s.pMarker),this.AdjustShadow(t),this.arStickers[t].obj.id&&e&&(this.SaveSticker(t),BX.admin.panel.Notify(this.MESS.CloseNotify.replace(/(.*?)#LINK#(.*?)#LINK#/gi,'$1<span class="bxst-close-notify-link" onclick="window.oBXSticker.ShowList(\'current\'); return false;">$2</span>')));var r=document.body.getElementsByTagName("A");r&&r[0]&&BX.focus(r[0])}},CollapseSticker:function(t,e,i){var s=this.arStickers[t];"undefined"==typeof i&&(i=!s.obj.collapsed),e&&this.curEditorStickerInd===t&&this.SaveAndCloseEditor(t,!0,!1),i?(BX.addClass(s.pWin.Get(),"bxst-collapsed"),s.pCollapseBut.title=this.MESS.UnCollapse,s.pWin.Get().style.height="19px",s.pCollapsedTitle.innerHTML=this.GetCollapsedContent(s.obj.html_content)):(BX.removeClass(s.pWin.Get(),"bxst-collapsed"),s.pCollapseBut.title=this.MESS.Collapse,s.pWin.Get().style.height=parseInt(s.obj.height)+"px"),this.AdjustShadow(t),s.obj.collapsed=i,s.obj.id&&e&&this.SaveSticker(t)},OnDragEnd:function(t){setTimeout(function(){t.__stWasDragged=!1},200);var e=t.StickerInd;this.arStickers[e].obj.top=parseInt(t.Get().style.top),this.arStickers[e].obj.left=parseInt(t.Get().style.left),this.SaveSticker(e)},OnDragDrop:function(t){this.AdjustShadow(t.StickerInd)},OnResizeEnd:function(t){var e=t.StickerInd;this.arStickers[e].bResizingNow=!1,this.arStickers[e].obj.width=parseInt(t.Get().style.width),this.arStickers[e].obj.height=parseInt(t.Get().style.height),this.arStickers[e].obj.id&&this.SaveSticker(e)},OnResizeStart:function(t){this.arStickers[t.StickerInd].bResizingNow=!0},ShowEditor:function(t){var e=t.ind===-1,i=this,s=this.arStickers[t.ind];if(this.pEditorCont||(this.pEditorCont=(e?document.body:s.pBody).appendChild(BX.create("DIV",{props:{className:"bxst-lhe-cont"}}))),this.pEditorCont.style.visibility="hidden",window.oLHESticker)this.bLoadLHEEditor&&(this.PrepareEditorAfterLoading(),this.bLoadLHEEditor=!1),e||this.DisplayEditor(s,t.ind);else if(this.bLoadLHEEditor){if(i.bLoadLHEEditor&&!window.oLHESticker)return setTimeout(function(){i.ShowEditor(t)},50)}else this.Request("load_lhe",{},function(e){i.pEditorCont.innerHTML=e;var s=setInterval(function(){if("undefined"!=typeof window.LoadLHE_LHEBxStickers)return clearInterval(s),i.bLoadLHEEditor||window.oLHESticker||LoadLHE_LHEBxStickers(),setTimeout(function(){i.bLoadLHEEditor=!0,i.ShowEditor(t)},50)},50)})},PrepareEditorAfterLoading:function(){oLHESticker&&(oLHESticker.oSpecialParsers.st_title={Parse:function(t,e,i){return e=e.replace(/\[ST_TITLE\]((?:\s|\S)*?)\[\/ST_TITLE\]/gi,'<span id="'+i.SetBxTag(!1,{tag:"st_title"})+'" class="bxst-title" >$1</span>')},UnParse:function(t,e,s){var r="[ST_TITLE]";for(i=0;i<e.arNodes.length;i++)r+=s._RecursiveGetHTML(e.arNodes[i]);return r+="[/ST_TITLE]"}},BX.addCustomEvent(oLHESticker,"OnUnParseContentAfter",function(){this.__sContent=this.__sContent.replace(/\[\/ST_TITLE\](?:\n|\r)+/gi,"[/ST_TITLE]\n")}))},DisplayEditor:function(t,e,i){var s=this;if(i)setTimeout(function(){t.pBody.style.overflow="auto",s.pEditorCont.style.visibility="visible",t.pContentArea.style.display="none",s.pEditorCont.style.display="block",setTimeout(function(){oLHESticker.SetFocusToEnd()},100)},100);else{t.pBody.appendChild(this.pEditorCont),this.AdjustToSize(e),oLHESticker.SetContent(t.obj.content||this.GetNewStickerContent()+"\n"),oLHESticker.CreateFrame(),oLHESticker.SetEditorContent(oLHESticker.content),window.oLHESticker.pEditorDocument.body.className=this.colorSchemes[t.obj.colorInd].name,this.Params.useHotkeys&&BX.bind(window.oLHESticker.pEditorDocument,"keyup",BX.proxy(this.OnKeyUp,this)),setTimeout(function(){try{window.oLHESticker.pEditorDocument.execCommand("styleWithCSS",!1,!1)}catch(t){}},100),setTimeout(function(){try{window.oLHESticker.pEditorDocument.execCommand("styleWithCSS",!1,!1)}catch(t){}},500),setTimeout(function(){try{window.oLHESticker.pEditorDocument.execCommand("styleWithCSS",!1,!1)}catch(t){}},1e3),this.curEditorStickerInd=e,t.pBody.style.overflow="hidden";var r=0,o=1,a=22,n=setInterval(function(){r>=a?r=a:r+=o,t.pContentArea.style.top=r+"px",r==a&&(clearInterval(n),s.DisplayEditor(t,e,!0))},BX.browser.IsIE()?5:10)}},AddToSticker:function(t){var e=this.arStickers[t];this.curEditorStickerInd===t&&window.oLHESticker?(oLHESticker.SetFocusToEnd(),oLHESticker.InsertHTML("<br />"+oLHESticker.ParseContent(this.GetNewStickerContent())+"<br />"),setTimeout(function(){oLHESticker.SetFocusToEnd()},100)):(e.obj.content+="\n"+this.GetNewStickerContent(),this.ShowEditor({ind:t}))},Request:function(t,e,i,s){s=s===!0,s&&BX.showWait();var r="/bitrix/admin/fileman_stickers.php?sticker_action="+t+"&"+this.sessid_get+"&site_id="+this.Params.site_id;return BX.ajax.post(r,e||{},function(t){s&&BX.closeWait(),i&&setTimeout(function(){i(t)},10)})},SetUnselectable:function(t){"object"!=typeof t&&(t=[t]);for(var e=0,i=t.length;e<i;e++)BX.setUnselectable(t[e]),t[e].ondragstart=function(t){return BX.PreventDefault(t)}},ShowColorOverlay:function(t,e,i){var s,r=this,o=0,a=this.arStickers[t];this.pColorOverlay||(this.pColorOverlay=document.body.appendChild(BX.create("DIV",{props:{className:"bx-sticker-overlay"}}))),this.pColorOverlay.style.zIndex=parseInt(a.pWin.Get().style.zIndex)+10,this.pColorOverlay.style.top=a.pWin.Get().style.top,this.pColorOverlay.style.left=a.pWin.Get().style.left,this.pColorOverlay.style.width=a.pWin.Get().style.width,this.pColorOverlay.style.height=a.pWin.Get().style.height,s=setInterval(function(){return o>2?(i?r.ChangeColor(t,e,!0,!1):r.pColorOverlay.className="bx-sticker-overlay",clearInterval(s)):(i?r.pColorOverlay.className="bx-sticker-overlay bx-sticker-op-"+o:r.pColorOverlay.className="bx-sticker-overlay bx-sticker-op-"+(3-o),void o++)},20)},DisplayStickers:function(t){for(var e=0,i=this.Stickers.length;e<i;e++)this.AddSticker(this.Stickers[e],t)},MousePos:function(t){return window.event&&(t=window.event),t.pageX||t.pageY?(t.realX=t.pageX,t.realY=t.pageY):(t.clientX||t.clientY)&&(t.realX=t.clientX+(document.documentElement.scrollLeft||document.body.scrollLeft)-document.documentElement.clientLeft,t.realY=t.clientY+(document.documentElement.scrollTop||document.body.scrollTop)-document.documentElement.clientTop),t},SaveAndCloseEditor:function(t,e,i){if(!window.oLHESticker||this.bLoadLHEEditor){var s=this;return setTimeout(function(){s.SaveAndCloseEditor(t,e)},100)}var r=this.arStickers[t];oLHESticker.SaveContent();var o=oLHESticker.GetContent(),a=oLHESticker.ParseContent(o);r.obj.html_content=a,r.pContentArea.innerHTML=a,this.arStickers[t].obj.content=o,e!==!1&&(r.pContentArea.style.display="block",this.pEditorCont.style.display="none",r.pContentArea.style.top="0px",r.pBody.style.overflow="auto",this.curEditorStickerInd=!1),i!==!1&&this.SaveSticker(t)},GetNewStickerContent:function(){var t=function(t){return t=parseInt(t),isNaN(t)&&(t=0),t<10?"0"+t.toString():t.toString()},e=new Date,i=this.Params.strDate+" "+t(e.getHours())+":"+t(e.getMinutes());return"[ST_TITLE]"+BX.util.htmlspecialchars(this.Params.curUserName)+" "+i+"[/ST_TITLE]\n"},SaveSticker:function(t){if("R"!=this.access){this.curEditorStickerInd===t&&this.SaveAndCloseEditor(t,!1,!1);var e=this.arStickers[t],i=this,s=Math.round(1e5*Math.random());if(window.__bxst_result[s]=!1,"undefined"==typeof e.obj.content&&(e.obj.content=this.GetNewStickerContent()+"\n"),e.obj.bNew){if(this._arSavedStickers[t])return;this._arSavedStickers[t]=!0}this.Request("save_sticker",{reqid:s,id:e.obj.bNew?0:e.obj.id,page_url:this.Params.pageUrl,page_title:this.Params.pageTitle,personal:e.obj.personal?"Y":"N",content:e.obj.content,width:e.obj.width,height:e.obj.height,top:e.obj.top,left:e.obj.left,color:e.obj.colorInd,collapsed:e.obj.collapsed?"Y":"N",completed:e.obj.completed?"Y":"N",closed:e.obj.closed?"Y":"N",marker:e.obj.marker},function(){if(window.__bxst_result[s]){var r=!!e.obj.bNew;i.arStickers[t].obj=i.ConvertStickerObj(window.__bxst_result[s]),i.arStickers[t].pHint&&(i.arStickers[t].pHint.HINT=i.arStickers[t].obj.info,i.arStickers[t].pHint.CONTENT_TEXT&&(i.arStickers[t].pHint.CONTENT_TEXT.innerHTML=i.arStickers[t].obj.info)),r?(i.UpdateNewSticker(t),i.arStickers[t].obj.closed||(i.curPageCount++,i.UpdateStickersCount())):i.arStickers[t].obj.closed&&(i.curPageCount--,i.UpdateStickersCount())}window.__bxst_result[s]=null})}},GetCollapsedContent:function(t){var e="";return t.indexOf("bxst-title")!=-1&&(e=t.replace(/<span[^>]*?class="bxst-title"[^>]*?>((?:\s|\S)*?)<\/span>/gi,function(t,e){return e.indexOf(String.fromCharCode(160))>0?'<span class="bxst-title">'+e.substr(0,e.indexOf(String.fromCharCode(160)))+"</span> ":e}),e=e.replace(/<br( \/)?>/gi," ")),""!=e?e:t},ConvertStickerObj:function(t){return{bNew:!1,id:parseInt(t.ID),personal:"Y"==t.PERSONAL,colorInd:t.COLOR||0,content:t.CONTENT,html_content:t.HTML_CONTENT,top:parseInt(t.POS_TOP),left:parseInt(t.POS_LEFT),width:parseInt(t.WIDTH),height:parseInt(t.HEIGHT),collapsed:"Y"==t.COLLAPSED,completed:"Y"==t.COMPLETED,closed:"Y"==t.CLOSED,info:t.INFO,authorName:t.AUTHOR,authorId:t.CREATED_BY,marker:t.MARKER_ADJUST||t.MARKER_WIDTH||t.MARKER_HEIGHT?{top:parseInt(t.MARKER_TOP),left:parseInt(t.MARKER_LEFT),width:parseInt(t.MARKER_WIDTH),height:parseInt(t.MARKER_HEIGHT),adjust:t.MARKER_ADJUST}:{}}},SetMarker:function(t,e){var i=this,s=this.arStickers[t];if(this.bHightlightElementMode=!1,this.bSelectAreaMode=!1,BX.removeClass(s.pMarkerElementBut,"bxst-pressed"),BX.removeClass(s.pMarkerAreaBut,"bxst-pressed"),this.oMarker||(this.oMarker={}),this.oMarker.StickerInd=t,s.pMarkerNode&&BX.removeClass(s.pMarkerNode,"bxst-sicked"),s.pMarker&&(s.pMarker.style.display="none",s.pMarker.style.top="-1000px"),s.markerResizer&&s.markerResizer.cont&&(s.markerResizer.cont.style.display="none"),s.obj&&s.obj.marker&&(s.obj.marker={}),this.oMarker.node=null,s.bSetMarkerMode=!0,"area"==e){BX.addClass(s.pMarkerAreaBut,"bxst-pressed"),setTimeout(function(){i.bSelectAreaMode=!0},10),this.oMarker.pOverlay||(this.oMarker.pOverlay=document.body.appendChild(BX.create("DIV",{props:{className:"bxst-marker-overlay"}}))),this.oMarker.pOverlay.style.display="block";var r=BX.GetWindowScrollSize(document);this.oMarker.pOverlay.style.width=r.scrollWidth+"px",this.oMarker.pOverlay.style.height=r.scrollHeight+"px",this.oMarker.pCursorHint||(this.oMarker.pCursorHint=document.body.appendChild(BX.create("DIV",{props:{className:"bxst-cursor-hint"},text:this.MESS.CursorHint}))),this.oMarker.pCursorHint.style.top="",this.oMarker.pCursorHint.style.left="",this.oMarker.pCursorHint.style.display="block",this.oMarker.pWnd=document.body.appendChild(BX.create("DIV")),this.oMarker.pWnd.className="bxst-cur-marker "+this.colorSchemes[s.obj.colorInd].name}else BX.addClass(s.pMarkerElementBut,"bxst-pressed"),setTimeout(function(){i.bHightlightElementMode=!0},10);BX.bind(document,"mousemove",BX.proxy(this.OnMouseMove,this)),BX.bind(document,"mouseup",BX.proxy(this.OnMouseUp,this))},OnMousedown:function(t){if(this.curEditorStickerInd!==!1&&window.oLHESticker&&!window.oLHESticker.bPopup){var e=this.arStickers[this.curEditorStickerInd];if(e&&e.pWin.Get()){var i=this.bSelectAreaMode||this.bHightlightElementMode,s=3,r=parseInt(e.pWin.Get().style.top)-s,o=parseInt(e.pWin.Get().style.left)-s,a=o+parseInt(e.pWin.Get().style.width)+2*s,n=r+parseInt(e.pWin.Get().style.height)+2*s;t=this.MousePos(t),(t.realX<o||t.realX>a||t.realY<r||t.realY>n)&&this.SaveAndCloseEditor(this.curEditorStickerInd,!i,!i)}}if(this.bSelectAreaMode)t=this.MousePos(t),this.bDrawMarkerMode=!0,this.oMarker.pCursorHint&&(this.oMarker.pCursorHint.style.display="none"),this.oMarker.from={top:t.realY,left:t.realX};else if(this.bHightlightElementMode){var l=!1;if(this.pCurMarkeredNode){l=!0;var d=this.pCurMarkeredNode.pNode.className;!d||d.indexOf("bx-sticker")==-1&&d.indexOf("bxst")==-1||d.indexOf("bxst-sicked")!=-1||(l=!1),l&&(l=!BX.findParent(this.pCurMarkeredNode.pNode,{className:new RegExp("bx-sticker","ig")}))}if(l)return BX.PreventDefault(t);this.MarkerHightlightNode()}},OnMouseMove:function(t){if(this.bHightlightElementMode){var e;t.target?e=t.target:t.srcElement&&(e=t.srcElement),3==e.nodeType&&(e=e.parentNode),e&&e.nodeName&&this.MarkerHightlightNode(e)}if(this.bSelectAreaMode){if(t=this.MousePos(t),this.oMarker.pCursorHint&&this.AdjustHintToCursor(this.oMarker.pCursorHint,t),!this.bDrawMarkerMode)return;this.oMarker.to={top:t.realY,left:t.realX};var i=this.oMarker.from.top,s=this.oMarker.from.left,r=Math.abs(this.oMarker.to.left-this.oMarker.from.left),o=Math.abs(this.oMarker.to.top-this.oMarker.from.top);this.oMarker.to.top<=this.oMarker.from.top&&this.oMarker.to.left>=this.oMarker.from.left?(i=this.oMarker.to.top,s=this.oMarker.from.left):this.oMarker.to.top>this.oMarker.from.top&&this.oMarker.to.left>this.oMarker.from.left?(i=this.oMarker.from.top,s=this.oMarker.from.left):this.oMarker.to.top>this.oMarker.from.top&&this.oMarker.to.left<this.oMarker.from.left?(i=this.oMarker.from.top,s=this.oMarker.to.left):this.oMarker.to.top<this.oMarker.from.top&&this.oMarker.to.left<this.oMarker.from.left&&(i=this.oMarker.to.top,s=this.oMarker.to.left),this.oMarker.pWnd.style.display="block",this.oMarker.pWnd.style.width=r+"px",this.oMarker.pWnd.style.height=o+"px",this.oMarker.pWnd.style.top=i+"px",this.oMarker.pWnd.style.left=s+"px",this.oMarker.top=i,this.oMarker.left=s,this.oMarker.width=r,this.oMarker.height=o}},OnMouseUp:function(t){if(this.bHightlightElementMode&&this.pCurMarkeredNode){var e=!1,i=this.pCurMarkeredNode.pNode.className;!i||i.indexOf("bx-sticker")==-1&&i.indexOf("bxst")==-1||i.indexOf("bxst-sicked")!=-1||(e=!0),e||(e=!!BX.findParent(this.pCurMarkeredNode.pNode,{className:new RegExp("bx-sticker","ig")})),e||(this.oMarker.node=this.pCurMarkeredNode.pNode)}if(this.bDrawMarkerMode=!1,this.bHightlightElementMode=!1,this.bSelectAreaMode=!1,this.oMarker.StickerInd>=0&&this.arStickers[this.oMarker.StickerInd]){var s=this.arStickers[this.oMarker.StickerInd];BX.removeClass(s.pMarkerElementBut,"bxst-pressed"),BX.removeClass(s.pMarkerAreaBut,"bxst-pressed"),s.bSetMarkerMode=!1}BX.unbind(document,"mousemove",BX.proxy(this.OnMouseMove,this)),BX.unbind(document,"mouseup",BX.proxy(this.OnMouseUp,this)),this.oMarker.pOverlay&&(this.oMarker.pOverlay.style.display="none"),this.oMarker.pCursorHint&&(this.oMarker.pCursorHint.style.display="none"),e||this.CreateMarker(this.oMarker)},MarkerHightlightNode:function(t){this.pCurMarkeredNode&&(this.pCurMarkeredNode.onclick&&(this.pCurMarkeredNode.pNode.onclick=this.pCurMarkeredNode.onclick),this.pCurMarkeredNode.onmousedown&&(this.pCurMarkeredNode.pNode.onmousedown=this.pCurMarkeredNode.onmousedown),BX.removeClass(this.pCurMarkeredNode.pNode,"bxst-sicked")),t?(this.pCurMarkeredNode={pNode:t},t.onclick&&(this.pCurMarkeredNode.onclick=t.onclick),t.onmousedown&&(this.pCurMarkeredNode.onmousedown=t.onmousedown),t.onmousedown=BX.proxy(this.OnMousedown,this),t.onclick=function(){return BX.PreventDefault(arguments[0])},BX.addClass(t,"bxst-sicked")):this.pCurMarkeredNode=!1},CreateMarker:function(t){if(t){var e=this.arStickers[t.StickerInd];if(t.node){e.pMarkerNode=t.node,e.obj.marker={adjust:this.GetNodeAdjustInfo(t.node)};var i=BX.pos(e.pMarkerNode);i&&(e.obj.marker.top=i.top-2,e.obj.marker.left=i.left-2,e.obj.marker.width=i.width-4,e.obj.marker.height=i.height-4)}else e.obj.marker={top:t.top,left:t.left,width:t.width,height:t.height},this.InitMagicAdjust(t.StickerInd);e.obj.marker&&(e.obj.marker.adjust||e.obj.marker.width&&e.obj.marker.height&&e.obj.marker.top&&e.obj.marker.left)&&(this.DisplayMarker(t.StickerInd,!0),this.AdjustStickerToArea(t.StickerInd)),this.oMarker.pWnd&&(this.oMarker.pWnd.style.display="none"),e.pWin.__stWasDragged||this.SaveSticker(t.StickerInd)}},DisplayMarker:function(t,e){var i=this.arStickers[t];if(i.pMarker&&(i.pMarker.style.display="none"),i.obj.marker&&i.obj.marker.adjust&&(i.pMarkerNode||(i.pMarkerNode=this.FindMarkerNode(i.obj.marker.adjust)),i.pMarkerNode)){var s=BX.pos(i.pMarkerNode);return s&&(i.pMarker||(i.pMarker=document.body.appendChild(BX.create("DIV",{props:{className:"bxst-sticker-marker "+this.colorSchemes[i.obj.colorInd].name}}))),e&&BX.addClass(i.pMarker,"bxst-marker-over"),i.pMarker.style.display="",i.pMarker.style.width=s.width-4+"px",i.pMarker.style.height=s.height-4+"px",i.pMarker.style.top=s.top-2+"px",i.pMarker.style.left=s.left-2+"px"),void BX.removeClass(i.pMarkerNode,"bxst-sicked")}i.obj.marker&&i.obj.marker.width>0&&(i.pMarker||(i.pMarker=document.body.appendChild(BX.create("DIV",{props:{className:"bxst-sticker-marker "+this.colorSchemes[i.obj.colorInd].name}}))),e&&BX.addClass(i.pMarker,"bxst-marker-over"),
i.pMarker.style.display="",i.pMarker.style.width=i.obj.marker.width+"px",i.pMarker.style.height=i.obj.marker.height+"px",i.pMarker.style.top=i.obj.marker.top+"px",i.pMarker.style.left=i.obj.marker.left+"px")},InitMagicAdjust:function(t){return},GetNodeAdjustInfo:function(t){var e=this._GetNodeAdjustInfo(t);return e=this._GetNodeAdjustSiblings(t,e)},_GetNodeAdjustInfo:function(t){var e={nodeName:t.nodeName.toLowerCase(),attr:{},innerHTML:null};if(t.innerHTML&&t.innerHTML.length&&(e.innerHTML=BX.util.trim(t.innerHTML.toLowerCase()),e.innerHTML=e.innerHTML.replace(/class=""/gi,""),e.innerHTML=e.innerHTML.replace(/class=''/gi,""),e.innerHTML=e.innerHTML.replace(/\n+/gi,""),e.innerHTML=e.innerHTML.replace(/\r+/gi,""),e.innerHTML=e.innerHTML.replace(/\s+/gi," "),e.innerHTML.length>250&&(e.innerHTML=e.innerHTML.substr(0,250))),t.attributes){var i,s=t.attributes.length;for(i=0;i<s;i++)name=t.attributes[i].name,name&&"string"==typeof name&&(name=name.toLowerCase(),this.oMarkerConfig.attr[name]&&(val=t.attributes[i].value,"class"!=name&&"classname"!=name||(name="classname",val=val.replace("bxst-sicked",""),val=BX.util.trim(val)),val.length>0&&(e.attr[name]=val)))}return e},_GetNodeAdjustSiblings:function(t,e){e.withId={};var i=BX.findParent(t,{attr:{id:new RegExp(".+","ig")}});i&&(e.withId.parent=i.getAttribute("id"));var s=BX.findChild(t,{attr:{id:new RegExp(".+","ig")}},!0,!0);if(s){e.withId.children=[];for(var r=0,o=s.length;r<o;r++)e.withId.children.push(s[r].getAttribute("id"))}var a=BX.findPreviousSibling(t,{attr:{id:new RegExp(".+","ig")}});a&&(e.withId.prevSibling=a.getAttribute("id"));var n=BX.findNextSibling(t,{attr:{id:new RegExp(".+","ig")}});return n&&(e.withId.nextSibling=n.getAttribute("id")),e},FindMarkerNode:function(t){var e=!1;if(!t||!t.nodeName)return!1;t.attr||(t.attr={}),t.attr.id&&(e=BX(t.attr.id));var i,s=[];if(e)s.push({coincide:100,node:e,bImpAttrCoincide:!0});else{if(t.withId||(t.withId={}),t.withId.prevSibling){var r=BX(t.withId.prevSibling);if(r)for(;(r=r.nextSibling)&&(i=this.TestNodeWithAttributes(r,t),i&&s.push(i),100!=i.coincide););}if(t.withId.nextSibling){var o=BX(t.withId.nextSibling);if(o)for(;(o=o.previousSibling)&&(i=this.TestNodeWithAttributes(o,t),i&&s.push(i),100!=i.coincide););}if(t.withId.children){var a,n,l,d=t.withId.children.length;for(a=0;a<d;a++)if(n=BX(t.withId.children[a]))for(l=n;;){if(l=BX.findParent(l,{tagName:t.nodeName}),!l)break;if(i=this.TestNodeWithAttributes(o,t),i&&s.push(i),100==i.coincide)break}}var c;t.withId.parent&&(c=BX(t.withId.parent)),c||(c=document.body);var a,h=c.getElementsByTagName(t.nodeName),d=h.length;for(a=0;a<d&&(i=this.TestNodeWithAttributes(h[a],t),i&&s.push(i),100!=i.coincide);a++);}var a,d=s.length,p=[],u=0,k=!1;for(a=0;a<d;a++)s[a].coincide>u&&(u=s[a].coincide,k=s[a].node,p=[]),s[a].coincide==u&&s[a].node!=k&&p.push(s[a].node);return 0==p.length&&k?k:(p[0],!1)},TestNodeWithAttributes:function(t,e){if(!t||!t.nodeName)return!1;var s={coincide:0,node:t},r=this._GetNodeAdjustInfo(t);if(r.nodeName!=e.nodeName)return!1;var o=0,a="string"==typeof e.innerHTML;if("string"!=typeof r.innerHTML&&a)return!1;var n=0;for(i in e.attr)"string"==typeof e.attr[i]&&n++;if(n>0){o=100/(n+(a?1:0));var l=!0;for(i in e.attr)"string"==typeof e.attr[i]&&(e.attr[i]==r.attr[i]?s.coincide+=o:this.oMarkerConfig.impAttr[i]&&(l=!1));s.bImpAttrCoincide=l}return a&&r.innerHTML==e.innerHTML&&(s.coincide+=n>0?o:95),s.coincide=Math.round(s.coincide),s.coincide>0&&s},OnDivMouseOver:function(t,e){var i=this.arStickers[t];if(i.bSetMarkerMode)return this.ShowButtonsPanel(t,!0,!1);i._over=e,i._overTimeout&&clearTimeout(i._overTimeout);var s=this;i._overTimeout=setTimeout(function(){i._over==e&&(s.ShowButtonsPanel(t,e),s.Hightlight(t,e))},e?100:500)},ShowButtonsPanel:function(t,e,i){this.Params.bHideBottom||(e=!0,i=!1),i=i!==!1;var s=this,r=this.arStickers[t],o=24,a=3,n=1,l=r.obj.height-(r.bButPanelShowed?0:o),d=l+o*(e?1:-1),c=BX.browser.IsIE()?3:10;if(!(this.bSelectAreaMode||this.bHightlightElementMode||r.obj.collapsed||r.obj.closed||r.bColSelShowed||r.bResizingNow)){if(r.bButPanelShowed==e)return r.pWin.Get().style.height=l+"px",this.AdjustShadow(t);var h=setInterval(function(){l+=a*n*(e?1:-1),(e&&l>=d||!e&&l<=d)&&(l=d),r.pWin.Get().style.height=l+"px",s.AdjustShadow(t),l==d&&(clearInterval(h),r.bButPanelShowed=e),n++},c)}},ShowColorSelector:function(t){var e,i=this,s=this.arStickers[t];if(s){if(!s.pColSelector){s.pColSelector=document.body.appendChild(BX.create("DIV",{props:{className:"bxst-col-sel"}}));for(var r=0,o=this.colorSchemes.length;r<o;r++)e=s.pColSelector.appendChild(BX.create("SPAN",{props:{id:"bxst_"+t+"_"+r,className:"bxst-col-pic "+this.colorSchemes[r].name,title:this.colorSchemes[r].title}})),e.onclick=function(){i.ChangeColor(t,parseInt(this.id.substr(("bxst_"+t+"_").length)),!0,!0),i.ShowColorSelector(t)};s.pColSelector.style.zIndex=this.Params.zIndex+20}if(s.bColSelShowed=!s.bColSelShowed,s.bColSelShowed){var a=BX.pos(s.pColorBut);s.pColSelector.style.top=parseInt(a.top)+16+"px",s.pColSelector.style.left=a.left+"px",s.pColSelector.style.display="block",this.ShowOverlay(!0,this.Params.zIndex+15),this.pTransOverlay.onmousedown=function(){i.ShowColorSelector(t)},BX.bind(document,"keydown",BX.proxy(function(e){this.OnKeyDown(e,t)},this))}else s.pColSelector.style.display="none",this.ShowOverlay(!1),BX.unbind(document,"keydown",BX.proxy(function(e){this.OnKeyDown(e,t)},this))}},ShowOverlay:function(t,e){if(this.pTransOverlay||(this.pTransOverlay=document.body.appendChild(BX.create("DIV",{props:{className:"bxst-trans-overlay"}}))),t){this.pTransOverlay.style.display="block",this.pTransOverlay.style.zIndex=e||800;var i=BX.GetWindowScrollSize(document);this.pTransOverlay.style.width=i.scrollWidth+"px",this.pTransOverlay.style.height=i.scrollHeight+"px"}else this.pTransOverlay.style.display="none",this.pTransOverlay.onmousedown=BX.False},OnKeyDown:function(t,e){t||(t=window.event);var i=t.which||t.keyCode;if(27==i){var s=this.arStickers[e];s&&s.bColSelShowed&&this.ShowColorSelector(e)}},SupaFlySticker:function(){return},Hightlight:function(t,e){var i=this.arStickers[t];i.bOver!==e&&(i.bOver=e,e?(i.pMarker&&BX.addClass(i.pMarker,"bxst-marker-over"),BX.addClass(i.pWin.Get(),"bx-sticker-over"),BX.addClass(i.pHead,"bxst-header-over"),i.pWin.Get().style.top=parseInt(i.pWin.Get().style.top)-1+"px",i.pWin.Get().style.left=parseInt(i.pWin.Get().style.left)-1+"px"):(i.pMarker&&BX.removeClass(i.pMarker,"bxst-marker-over"),BX.removeClass(i.pWin.Get(),"bx-sticker-over"),BX.removeClass(i.pHead,"bxst-header-over"),i.pWin.Get().style.top=parseInt(i.pWin.Get().style.top)+1+"px",i.pWin.Get().style.left=parseInt(i.pWin.Get().style.left)+1+"px"))},BlinkRed:function(t){var e,i=this,s=4,r=0,o=0,a=this.arStickers[t];this.pBlinkRed||(this.pBlinkRed=document.body.appendChild(BX.create("DIV",{props:{className:"bxst-blink-red"}}))),this.pBlinkRed.style.zIndex=parseInt(a.pWin.Get().style.zIndex)+10,this.pBlinkRed.style.top=a.pWin.Get().style.top,this.pBlinkRed.style.left=a.pWin.Get().style.left,this.pBlinkRed.style.width=a.pWin.Get().style.width,this.pBlinkRed.style.height=a.pWin.Get().style.height,bFadeIn=!0,e=setInterval(function(){return r>2?(bFadeIn?(i.pBlinkRed.className="bxst-blink-red bx-sticker-op-3",r=1):(i.pBlinkRed.className="bxst-blink-red",r=0),o++,bFadeIn=!bFadeIn,void(o>=s&&clearInterval(e))):(bFadeIn?i.pBlinkRed.className="bxst-blink-red bx-sticker-op-"+r:i.pBlinkRed.className="bxst-blink-red bx-sticker-op-"+(3-r),void r++)},BX.browser.IsIE()?30:60)},ShowList:function(t){this.List||(this.List=new BXStickerList(this)),this.List.Show(t)},OnKeyUp:function(t){t||(t=window.event);var e=t.which||t.keyCode;if(17==e){var i=this;this._bCtrlPressed=!0,setTimeout(function(){i._bCtrlPressed=!1},400)}else if(16==e){var i=this;this._bShiftPressed=!0,setTimeout(function(){i._bShiftPressed=!1},400)}else if((this._bShiftPressed||t.shiftKey)&&(t.ctrlKey||this._bCtrlPressed)){if(83==e&&"W"==this.Params.access)return this.AddSticker(),BX.PreventDefault(t);if(88==e)return this.ShowAll(),BX.PreventDefault(t);if(76==e)return this.ShowList("current"),BX.PreventDefault(t)}},UpdateStickersCount:function(){(this.curPageCount<0||isNaN(parseInt(this.curPageCount)))&&(this.curPageCount=0);var t=BX.findChild(BX("bxst-show-sticker-icon"),{tagName:"B"},!0);t&&(t.innerHTML="("+this.curPageCount+")")}},BXStickerList.prototype={Show:function(t){if(!this.bShowed){var e={content_url:"/bitrix/admin/fileman_stickers.php?sticker_action=show_list&"+this.BXSticker.sessid_get+"&cur_page="+this.BXSticker.Params.pageUrl+"&type="+t+"&site_id="+this.BXSticker.Params.site_id,title:this.MESS.StickerListTitle,width:this.BXSticker.Params.listWidth,height:this.BXSticker.Params.listHeight,min_width:800,min_height:400,resizable:!0,resize_id:"bx_sticker_list_resize_id"};this.type=t,this.bRefreshPage=!1,this.naviSize=this.BXSticker.Params.listNaviSize,this.oDialog=new BX.CDialog(e),this.oDialog.Show(),this.oDialog.SetButtons([this.oDialog.btnClose]),this.bShowed=!0;var i=this;BX.addCustomEvent(this.oDialog,"onWindowUnRegister",function(){i.bShowed=!1,i.bRefreshPage&&(window.location=window.location)}),BX.addCustomEvent(this.oDialog,"onWindowResizeFinished",function(){i.AdjustNaviSize()}),BX.addCustomEvent(this.oDialog,"onWindowExpand",function(){i.AdjustNaviSize()}),BX.addCustomEvent(this.oDialog,"onWindowNarrow",function(){i.AdjustNaviSize()})}},OnLoad:function(t){this.pAllBut=BX("bxstl_fil_all_but"),this.pMyBut=BX("bxstl_fil_my_but"),this.pColorCont=BX("bxstl_col_cont"),this.pOpenedBut=BX("bxstl_fil_opened_but"),this.pClosedBut=BX("bxstl_fil_closed_but"),this.pAllStickersBut=BX("bxstl_fil_all_p_but"),this.pItemsTable=BX("bxstl_items_table"),this.pItemsTableCnt=BX("bxstl_items_table_cnt"),this.pNaviCont=BX("bxstl_navi_cont"),"W"==this.access&&(this.pActionSel=BX("bxstl_action_sel"),this.pActionBut=BX("bxstl_action_ok")),this.pPageSelect=BX("bxstl_fil_page_sel"),"current"==this.type?(this.BXSticker.Params.filterParams.status="all",this.BXSticker.Params.filterParams.page="current"):"all"==this.type&&(this.BXSticker.Params.filterParams.status="opened",this.BXSticker.Params.filterParams.page="all");var e=this,i=this.BXSticker.Params.filterParams.colors;if(i&&"all"!=i&&i.length>0){this.checkedColors=[!1,!1,!1,!1,!1,!1];for(var s=0,r=i.length;s<r;s++)99!=i[s]&&(this.checkedColors[parseInt(i[s])]=!0)}else this.checkedColors=[!0,!0,!0,!0,!0,!0];if(!this.bRefreshPage&&window.__bxst_result.cur_page_ids!==!1&&"object"==typeof window.__bxst_result.cur_page_ids)for(var s in window.__bxst_result.cur_page_ids)this.arCurPageIds[parseInt(window.__bxst_result.cur_page_ids[s])]=!0;var s,o,a,r=this.BXSticker.colorSchemes.length,n=BX.browser.IsIE()&&!BX.browser.IsDoctype()?'style="width: 12px; height: 12px"':"";for(s=0;s<r;s++)o=this.BXSticker.colorSchemes[s],a=this.pColorCont.appendChild(BX.create("DIV",{props:{id:"bxstl_color_"+s,className:"bxstl-color-pick"+(this.checkedColors[s]?" bxstl-color-pick-ch":""),title:o.title},html:'<div class="bxstl-col-pic-l"></div><div class="bxstl-col-pic-c"><div class="'+o.name+'" '+n+'>&nbsp;</div></div><div class="bxstl-col-pic-r"></div>'})),a.onclick=function(){var t=parseInt(this.id.substr("bxstl_color_".length));e.checkedColors[t]=!e.checkedColors[t],e.checkedColors[t]?BX.addClass(this,"bxstl-color-pick-ch"):BX.removeClass(this,"bxstl-color-pick-ch"),e.ReloadList()};this.SetStickerType(this.BXSticker.Params.filterParams.type,!1),this.pAllBut.onclick=function(){e.SetStickerType("all")},this.pMyBut.onclick=function(){e.SetStickerType("my")},this.SetStickerStatus(this.BXSticker.Params.filterParams.status,!1),this.pOpenedBut.onclick=function(){e.SetStickerStatus("opened")},this.pClosedBut.onclick=function(){e.SetStickerStatus("closed")},this.pAllStickersBut.onclick=function(){e.SetStickerStatus("all")},"W"==this.access&&(this.pActionBut.onclick=function(){e.Action()}),this.pPageSelect.onchange=function(){e.SetPage(this.value)},this.SetPage("current"==this.BXSticker.Params.filterParams.page?this.BXSticker.Params.pageUrl:this.BXSticker.Params.filterParams.page,!1),t=parseInt(t),this.oDialog.SetTitle(this.MESS.StickerListTitle+" ("+t+")"),this.EnableActionBut(!1)},SetStickerStatus:function(t,e){"opened"==t?(BX.addClass(this.pOpenedBut,"bxstl-but-checked"),BX.removeClass(this.pClosedBut,"bxstl-but-checked"),BX.removeClass(this.pAllStickersBut,"bxstl-but-checked")):"closed"==t?(BX.removeClass(this.pOpenedBut,"bxstl-but-checked"),BX.addClass(this.pClosedBut,"bxstl-but-checked"),BX.removeClass(this.pAllStickersBut,"bxstl-but-checked")):(BX.removeClass(this.pOpenedBut,"bxstl-but-checked"),BX.removeClass(this.pClosedBut,"bxstl-but-checked"),BX.addClass(this.pAllStickersBut,"bxstl-but-checked")),this.StickersStatus=t,e!==!1&&this.ReloadList()},SetStickerType:function(t,e){"all"==t?(BX.addClass(this.pAllBut,"bxstl-but-checked"),BX.removeClass(this.pMyBut,"bxstl-but-checked")):(BX.addClass(this.pMyBut,"bxstl-but-checked"),BX.removeClass(this.pAllBut,"bxstl-but-checked")),this.StickersType=t,e!==!1&&this.ReloadList()},SetPage:function(t,e){this.pPageSelect.value=t,this.StickersPage=t,e!==!1&&this.ReloadList()},NaviGet:function(t,e){var i={};i["PAGEN_"+e]=t,this.ReloadList(i)},ReloadList:function(t){var e=this;t||(t={}),t.sticker_just_res="Y",t.colors=[99],t.sticker_type=this.StickersType,t.sticker_status=this.StickersStatus,t.sticker_page=this.StickersPage,t.navi_size=this.naviSize,t.cur_page=this.BXSticker.Params.pageUrl,t.type=this.type;var i,s=this.checkedColors.length;for(i=0;i<s;i++)this.checkedColors[i]===!0&&t.colors.push(i);window.__bxst_result.list_rows_count=!1,window.__bxst_result.cur_page_ids=!1,this.BXSticker.Request("show_list",t,function(t){var i=t.split("#BX_STICKER_SPLITER#");if(2==i.length&&(e.pItemsTableCnt.innerHTML=i[0],e.pNaviCont.innerHTML=i[1]),window.__bxst_result.list_rows_count!==!1&&e.oDialog.SetTitle(e.MESS.StickerListTitle+" ("+parseInt(window.__bxst_result.list_rows_count)+")"),!e.bRefreshPage&&window.__bxst_result.cur_page_ids!==!1&&"object"==typeof window.__bxst_result.cur_page_ids)for(var s in window.__bxst_result.cur_page_ids)e.arCurPageIds[parseInt(window.__bxst_result.cur_page_ids[s])]=!0;e.pItemsTable=BX("bxstl_items_table"),e.EnableActionBut(!1)},!0)},AdjustToSize:function(t,e){},AdjustNaviSize:function(){var t,e=parseInt(this.oDialog.GetContent().style.height),i=40,s=e-100-80;s!=i*this.naviSize&&(t=Math.floor(s/i)),t<5&&(t=5),t>30&&(t=30),this.naviSize!=t&&(this.naviSize=t,this.ReloadList())},CheckAll:function(t){var e,i=this.pItemsTable.rows.length,s=!1;for(e=1;e<i;e++)7==this.pItemsTable.rows[e].cells.length&&(this.pItemsTable.rows[e].cells[6].firstChild.checked=!!t,s=!0);s&&this.EnableActionBut(t)},Action:function(){if("W"==this.access){var t=this.pActionSel.value;if(""!=t&&("del"!=t||confirm(this.MESS.DelConfirm))){var e,i=this.pItemsTable.rows.length,s=[];for(e=1;e<i;e++)this.pItemsTable.rows[e].cells.length<7||(ch=this.pItemsTable.rows[e].cells[6].firstChild,ch.checked&&(s.push(ch.value),!this.bRefreshPage&&this.arCurPageIds[parseInt(ch.value)]&&(this.bRefreshPage=!0)));this.ReloadList({list_action:t,list_ids:s})}}},EnableActionBut:function(t){if("W"==this.access){if("check"==t){var e,i=this.pItemsTable.rows.length,t=!1;for(e=1;e<i;e++)if(!(this.pItemsTable.rows[e].cells.length<7)&&this.pItemsTable.rows[e].cells[6].firstChild.checked){t=!0;break}}this.pActionBut.disabled=!t,this.pActionSel.disabled=!t}}};
//# sourceMappingURL=maps/sticker.js.map
